---
title: "Outfall Data- kMeans clusters"
output: github_document
always_allow_html: true
params: 
  coc: "Metals"
---

```{r include=FALSE, setup, include=FALSE}

knitr::opts_chunk$set(echo=FALSE, 
  comment = '', fig.width = 6, fig.height = 6
)



library(tidyverse)
library(pastecs)
library(factoextra)
library(cluster)
library(DataExplorer)
library(tidymodels)
library(caret)
library(broom)
library(knitr)
library(kableExtra)
library(gtsummary)
```

```{r}

load("~/GitHub/s8Regressions/data/s8_data.rda")


ps <- s8_data$paramgroup %>% unique()

library(rlist)
s8_data<- s8_data %>% as.data.frame()
study_names <- s8_data$study_name
study_names_list <- s8_data$study_name %>% unique() %>% sort()

study_id <- study_names_list %>%  as.factor() %>% as.numeric()
types <- s8_data$type %>% unique()

study_names_short <- c('sea','tac','clark','king','pierce','pos','pot','sno')


lookup <- setNames(as.list(study_names_short), study_names_list)

s8_data <- s8_data %>% 
  mutate(short_name =dplyr::recode(study_names, !!!lookup)) %>% 
  mutate(site_name = paste(sep = "-",dplyr::recode(study_names, !!!lookup),type)) %>% 
   filter(short_name != "clark") %>% 
  filter(sample_matrix %in% c("water", "Water", "WATER")) %>% 
   filter(paramgroup %in% c("Metal","Conventional")) %>% 
filter(!parameter %in% c(
  "Cadmium - Water - Dissolved",
    "Biochemical Oxygen Demand - Water - Total", 
    "Magnesium - Water - Dissolved","Magnesium - Water - Total", "Chloride - Water - Total",
   # "Total Suspended Solids - Water - Total",
   "Surfactants - Water - Total",
   "Conductivity - Water - Total","Turbidity - Water - Total",
    "Ammonia - Water - Total",
    "Mercury - Water - Total", "Mercury - Water - Dissolved", "Arsenic - Water - Dissolved",
    "Calcium - Water - Dissolved", "pH - Water - Total", "Calcium - Water - Total", "Hardness as CaCO3 - Water - Total" #"Magnesium - Water - Total"
    )) 


s8_data %>% select(c("site_name","parameter","new_result_value")) %>% 
  pivot_wider(names_from = site_name, values_from= new_result_value, values_fn = length) %>%  kable(caption = "Number of sampling events") %>% kable_classic(full_width = F)

s8_data %>% select(c("site_name","parameter","nondetect_flag","new_result_value")) %>% 
  mutate(nondetect = (nondetect_flag == TRUE) %>% as.numeric()) %>% 
  select(-c('nondetect_flag')) %>% 
  group_by(site_name,parameter) %>% summarise(percent = sum(nondetect)/length(new_result_value)) %>% 
  ungroup() %>% 
  pivot_wider(id_cols =  parameter, values_from = c(percent),names_from = site_name) %>% 

  
   mutate_if(is.numeric,funs(paste0(round(.,2)*100,"%" ))) %>% 
#,values_from = c(n,percent)) %>% 
  #arrange(desc(`king-COM`)) %>% 
  #add_column(after = 1, colSums(everything())) %>% 
  kable(caption = "percent-nondetects summary") %>% 
  kable_classic(html_font = 'serif', full_width = T)


```

```{r}
short_names = unique(s8_data$short_name)
site_names =  unique(s8_data$site_name)
i = 1

clus <- function(i) {
  

data.df <- s8_data %>% 
  #Metal", "Nutrient","Conventional")) %>%  #Conventional","Nutrient")) %>% #Nutrient","Conventional")) %>%
#filter(short_name ==short_names[i]) %>% 
  filter(site_name ==site_names[i]) %>% 
 
  mutate(loc_date = paste0(site_name, "_",field_collection_start_date)) %>%
  pivot_wider(
    names_from = loc_date, id_cols = parameter,
    values_from = new_result_value,
    values_fn = mean
  ) %>%
  remove_rownames() %>%
  column_to_rownames("parameter") %>%
  log() %>% 
  t() %>%
  as.data.frame() %>%
  drop_na() %>%
  scale(center = TRUE, scale = TRUE) %>% 
  t() %>%
  as.data.frame() 


# 
km <- kmeans(data.df, 3)
# km <- fanny(data.df2)

#return(fviz_nbclust(data.df2, kmeans, method = "silhouette"))

 return(
fviz_cluster(km,main = site_names[i],subtitle = paste("n =", ncol(data.df)), data = data.df,repel =TRUE,show.clust.cent = FALSE,ellipse.type = "confidence", ellipse.level = 0.90)
)
# # outplots[i] <- fviz_cluster(km.res1, data = data.df2,repel =TRUE,ellipse.type = "convex",show.clust.cent = FALSE)

}


```


```{r}


for (i in 1:length(site_names)){
  
  try(print(clus(i),silent = TRUE))
}
```
